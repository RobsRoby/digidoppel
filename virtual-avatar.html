<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Avatar with Face Mesh</title>
    
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            color: #f8f9fa;
            background: url('BG.png') no-repeat center center fixed;
            background-size: cover;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .container {
            text-align: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
        }
        
        #avatarCanvas { 
            border-radius: 50%; 
            background-color: #4B9CFF;
            background: url('bg_zoom.png') no-repeat center center;
            background-size: cover;
            margin: 20px auto; 
            display: block; 
            position: relative; 
            z-index: 0; 
        }

        #videoElement { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            width: 200px; 
            height: 150px; 
            object-fit: cover; 
            border: 2px solid #fff; 
            border-radius: 10px; 
            z-index: 1; 
        }
        
        #fileUploader {
            margin-top: 20px;
            font-family: 'Poppins', sans-serif;
            color: #f8f9fa;
            background-color: transparent;
            border: 1px solid #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        #fileUploader::file-selector-button {
            background-color: #f8f9fa;
            color: #000;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
    <!-- Import maps for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/"
            }
        }
    </script>
    <!-- Load Mediapipe and its dependencies using script tags -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    
</head>
<body>
    <video id="videoElement" autoplay></video>
    <div class="container">
        <h1 class="display-4">Virtual Avatar with Face Mesh</h1>
        <p class="lead">This uses TensorFlow.js to create a live virtual avatar that tracks your face using Face Mesh.</p>
        <canvas id="avatarCanvas" width="300" height="300"></canvas>
        <input type="file" id="fileUploader" accept="image/*">
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    
        const avatarCanvas = document.getElementById('avatarCanvas');
        const videoElement = document.getElementById('videoElement');
        const fileUploader = document.getElementById('fileUploader');
    
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, avatarCanvas.width / avatarCanvas.height, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: avatarCanvas, alpha: true });
        renderer.setSize(avatarCanvas.width, avatarCanvas.height);
        camera.position.z = 240;
    
        const loader = new FBXLoader();
        let faceModel;
    
        loader.load('head.fbx', (object) => {
            faceModel = object;
            scene.add(faceModel);
        });
    
        const light = new THREE.AmbientLight(0x404040,30);
        scene.add(light);
    
        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && faceModel) {
                const landmarks = results.multiFaceLandmarks[0];
    
                const nose = landmarks[1];
                faceModel.position.set((nose.x - 0.5) * 2, -(nose.y + 5) * 2, 0);
    
                const leftCheek = landmarks[234];
                const rightCheek = landmarks[454];
                const faceWidth = Math.sqrt(Math.pow(leftCheek.x - rightCheek.x, 2) + Math.pow(leftCheek.y - rightCheek.y, 2));
                faceModel.scale.set(faceWidth, faceWidth, faceWidth);
            }
            renderer.render(scene, camera);
        }
    
        async function loadFaceMeshModel() {
            const faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });
    
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
    
            faceMesh.onResults(onResults);
    
            videoElement.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
            const cameraMP = new Camera(videoElement, {
                onFrame: async () => await faceMesh.send({ image: videoElement }),
                width: 640,
                height: 480
            });
    
            cameraMP.start();
        }
    
        loadFaceMeshModel();

        // Handle file upload and change avatar background
        fileUploader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarCanvas.style.backgroundImage = `url(${e.target.result})`;
            }
            reader.readAsDataURL(file);
        });
    </script>
    
</body>
</html>
